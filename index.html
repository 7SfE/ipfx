<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络设备安全分析报告系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo i {
            font-size: 2.2rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .logo p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .status-indicator {
            display: flex;
            gap: 15px;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 10px 15px;
            border-radius: 8px;
            min-width: 100px;
        }
        
        .status-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .status-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .upload-section {
            padding: 25px 30px;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f8fafc;
        }
        
        .upload-area {
            border: 2px dashed #1a73e8;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: white;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            background-color: #f0f7ff;
            border-color: #0d47a1;
        }
        
        .upload-area i {
            font-size: 3rem;
            color: #1a73e8;
            margin-bottom: 15px;
        }
        
        .upload-area h3 {
            margin-bottom: 10px;
            color: #1a73e8;
        }
        
        .upload-area p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .upload-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1a73e8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0d47a1;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #f1f3f4;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #e8eaed;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: #34a853;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2e8b47;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: #f9ab00;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e09900;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #ea4335;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d23c2f;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: #1a73e8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #0d47a1;
            transform: translateY(-2px);
        }
        
        .dashboard {
            padding: 25px 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .dashboard-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            padding: 20px;
            border-top: 4px solid #1a73e8;
        }
        
        .dashboard-card h3 {
            margin-bottom: 15px;
            color: #1a73e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-content {
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .chart-container {
            width: 100%;
            height: 100%;
        }
        
        .device-table-section {
            padding: 0 30px 30px;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .table-header h3 {
            color: #1a73e8;
        }
        
        .filter-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: white;
            min-width: 120px;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        thead {
            background-color: #1a73e8;
            color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            max-width: 150px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        tbody tr {
            transition: background-color 0.2s;
        }
        
        tbody tr:hover {
            background-color: #f5f7fa;
        }
        
        .status-online {
            color: #34a853;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .status-offline {
            color: #ea4335;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .status-unknown {
            color: #9aa0a6;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .device-type-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            display: inline-block;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .device-type-computer {
            background-color: #e8f0fe;
            color: #1a73e8;
        }
        
        .device-type-printer {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .device-type-router {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .device-type-switch {
            background-color: #fce4ec;
            color: #c2185b;
        }
        
        .device-type-server {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        
        .device-type-other {
            background-color: #f5f5f5;
            color: #666;
        }
        
        .domestic-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .domestic-yes {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .domestic-no {
            background-color: #fce4ec;
            color: #c2185b;
        }
        
        .risk-high {
            color: #ea4335;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .risk-medium {
            color: #f9ab00;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .risk-low {
            color: #34a853;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .risk-none {
            color: #9aa0a6;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .edit-btn {
            color: #1a73e8;
        }
        
        .edit-btn:hover {
            background-color: #e8f0fe;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header h3 {
            color: #1a73e8;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        
        footer {
            padding: 20px 30px;
            text-align: center;
            color: #666;
            border-top: 1px solid #e0e0e0;
            font-size: 0.9rem;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.85rem;
        }
        
        .export-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .export-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .export-dropdown-content a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
        }
        
        .export-dropdown-content a:hover {
            background-color: #f1f1f1;
        }
        
        .export-dropdown:hover .export-dropdown-content {
            display: block;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .status-indicator {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .upload-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filter-container {
                width: 100%;
                justify-content: space-between;
            }
            
            .filter-select {
                flex: 1;
                min-width: 0;
            }
            
            .export-dropdown-content {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <div>
                    <h1>网络设备安全分析报告系统</h1>
                    <p>网络安全监测与风险评估平台</p>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-item">
                    <span class="status-value" id="online-count">0</span>
                    <span class="status-label">在线设备</span>
                </div>
                <div class="status-item">
                    <span class="status-value" id="offline-count">0</span>
                    <span class="status-label">离线设备</span>
                </div>
                <div class="status-item">
                    <span class="status-value" id="domestic-percent">0%</span>
                    <span class="status-label">国产化率</span>
                </div>
            </div>
        </header>
        
        <section class="upload-section">
            <div class="upload-area">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>上传网络扫描CSV文件</h3>
                <p>支持两种格式：设备状态CSV和端口扫描CSV。系统将自动解析并分析网络设备安全状况。</p>
                <div class="upload-buttons">
                    <button class="btn btn-primary" id="uploadDeviceFileBtn">
                        <i class="fas fa-upload"></i> 上传设备状态CSV
                    </button>
                    <button class="btn btn-primary" id="uploadScanFileBtn">
                        <i class="fas fa-upload"></i> 上传端口扫描CSV
                    </button>
                    <button class="btn btn-secondary" id="loadDemoDataBtn">
                        <i class="fas fa-download"></i> 加载示例数据
                    </button>
                    <div class="export-dropdown">
                        <button class="btn btn-success">
                            <i class="fas fa-file-export"></i> 导出安全报告
                        </button>
                        <div class="export-dropdown-content">
                            <a href="#" id="exportHtmlBtn"><i class="fas fa-file-code"></i> 导出HTML报告</a>
                            <a href="#" id="exportDocBtn"><i class="fas fa-file-word"></i> 导出DOC报告</a>
                            <a href="#" id="exportDataBtn"><i class="fas fa-file-export"></i> 导出原始数据</a>
                        </div>
                    </div>
                    <button class="btn btn-warning" id="importDataBtn">
                        <i class="fas fa-file-import"></i> 导入数据
                    </button>
                    <button class="btn btn-danger" id="clearDataBtn">
                        <i class="fas fa-trash-alt"></i> 清除全部数据
                    </button>
                </div>
                <input type="file" id="deviceFileInput" accept=".csv" style="display: none;">
                <input type="file" id="scanFileInput" accept=".csv" style="display: none;">
                <input type="file" id="importFileInput" accept=".json" style="display: none;">
            </div>
        </section>
        
        <section class="dashboard">
            <div class="dashboard-card">
                <h3>设备状态统计 <button class="btn btn-secondary btn-small" id="showOnlineStatsBtn"><i class="fas fa-chart-bar"></i> 查看详情</button></h3>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>安全风险分布 <button class="btn btn-secondary btn-small" id="showRiskStatsBtn"><i class="fas fa-exclamation-triangle"></i> 查看详情</button></h3>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>设备类型分布 <button class="btn btn-secondary btn-small" id="showDeviceTypesBtn"><i class="fas fa-network-wired"></i> 查看详情</button></h3>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="deviceTypeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>国产设备比例 <button class="btn btn-secondary btn-small" id="showDomesticStatsBtn"><i class="fas fa-flag"></i> 查看详情</button></h3>
                <div class="card-content">
                    <div class="chart-container">
                        <canvas id="domesticChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="device-table-section">
            <div class="table-header">
                <h3><i class="fas fa-list"></i> 设备列表</h3>
                <div class="filter-container">
                    <input type="text" id="searchInput" placeholder="搜索设备..." class="form-control" style="width: 200px;">
                    <select id="statusFilter" class="filter-select">
                        <option value="">所有状态</option>
                        <option value="在线">在线</option>
                        <option value="离线">离线</option>
                        <option value="未知">未知</option>
                    </select>
                    <select id="deviceTypeFilter" class="filter-select">
                        <option value="">所有类型</option>
                        <option value="计算机">计算机</option>
                        <option value="打印机">打印机</option>
                        <option value="路由器">路由器</option>
                        <option value="交换机">交换机</option>
                        <option value="服务器">服务器</option>
                        <option value="其他">其他</option>
                    </select>
                    <select id="domesticFilter" class="filter-select">
                        <option value="">国产/非国产</option>
                        <option value="国产">国产</option>
                        <option value="非国产">非国产</option>
                    </select>
                    <select id="riskFilter" class="filter-select">
                        <option value="">所有风险</option>
                        <option value="高风险">高风险</option>
                        <option value="中风险">中风险</option>
                        <option value="低风险">低风险</option>
                        <option value="无风险">无风险</option>
                    </select>
                    <button class="btn btn-secondary" id="refreshBtn"><i class="fas fa-sync-alt"></i> 刷新</button>
                </div>
            </div>
            <div class="table-container">
                <table id="deviceTable">
                    <thead>
                        <tr>
                            <th>状态</th>
                            <th>设备名称</th>
                            <th>IP地址</th>
                            <th>设备类型</th>
                            <th>MAC地址</th>
                            <th>国产标识</th>
                            <th>开放服务</th>
                            <th>安全风险</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <!-- 数据将通过JS动态加载 -->
                    </tbody>
                </table>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #34a853;"></div>
                    <span>在线设备</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ea4335;"></div>
                    <span>离线设备</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e8f5e9;"></div>
                    <span>国产设备</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #fce4ec;"></div>
                    <span>非国产设备</span>
                </div>
            </div>
        </section>
        
        <footer>
            <p>© 2025 网络安全分析系统 | 维护人员: msyg | 数据更新时间: <span id="updateTime"></span> | 版本: <span id="version">2.4</span></p>
        </footer>
    </div>
    
    <!-- 编辑设备信息模态框 -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> 编辑设备信息</h3>
                <button class="close-btn" id="closeEditModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="form-group">
                        <label for="editName">设备名称</label>
                        <input type="text" id="editName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editIp">IP地址</label>
                        <input type="text" id="editIp" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editType">设备类型</label>
                        <select id="editType" class="form-control">
                            <option value="计算机">计算机</option>
                            <option value="打印机">打印机</option>
                            <option value="路由器">路由器</option>
                            <option value="交换机">交换机</option>
                            <option value="服务器">服务器</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editMac">MAC地址</label>
                        <input type="text" id="editMac" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="editDomestic">国产标识</label>
                        <select id="editDomestic" class="form-control">
                            <option value="是">是</option>
                            <option value="否">否</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">状态</label>
                        <select id="editStatus" class="form-control">
                            <option value="在线">在线</option>
                            <option value="离线">离线</option>
                            <option value="未知">未知</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editNotes">备注</label>
                        <textarea id="editNotes" class="form-control" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="editIndex">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditBtn">取消</button>
                <button class="btn btn-primary" id="saveEditBtn">保存更改</button>
            </div>
        </div>
    </div>
    
    <!-- 统计详情模态框 -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="statsTitle"></h3>
                <button class="close-btn" id="closeStatsModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="statsContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeStatsBtn">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 导入数据模态框 -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-import"></i> 导入数据</h3>
                <button class="close-btn" id="closeImportModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p>请上传之前导出的JSON数据文件：</p>
                <input type="file" id="importFileInputModal" accept=".json" class="form-control">
                <div id="importPreview" style="margin-top: 20px; display: none;">
                    <h4>数据预览</h4>
                    <pre id="importDataPreview" style="background-color: #f5f5f5; padding: 15px; border-radius: 6px; max-height: 200px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelImportBtn">取消</button>
                <button class="btn btn-primary" id="confirmImportBtn">导入数据</button>
            </div>
        </div>
    </div>
    
    <!-- 确认清除数据模态框 -->
    <div id="confirmClearModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> 确认清除数据</h3>
                <button class="close-btn" id="closeConfirmClearModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-trash-alt" style="font-size: 4rem; color: #ea4335; margin-bottom: 20px;"></i>
                    <h3 style="color: #ea4335; margin-bottom: 15px;">警告：此操作不可撤销！</h3>
                    <p style="margin-bottom: 10px;">您确定要清除所有数据吗？这将删除：</p>
                    <ul style="text-align: left; margin-left: 30px; margin-bottom: 20px;">
                        <li>所有已加载的设备数据</li>
                        <li>所有扫描数据</li>
                        <li>所有图表统计数据</li>
                        <li>本地存储中的所有数据</li>
                    </ul>
                    <p style="color: #666; font-size: 0.9rem;">建议在清除前先导出数据备份。</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelClearBtn">取消</button>
                <button class="btn btn-danger" id="confirmClearBtn">确认清除全部数据</button>
            </div>
        </div>
    </div>
    
    <!-- 重复数据确认模态框 -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-circle"></i> 发现重复数据</h3>
                <button class="close-btn" id="closeDuplicateModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="duplicateContent">
                    <!-- 动态内容 -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="skipDuplicateBtn">跳过</button>
                <button class="btn btn-primary" id="overwriteDuplicateBtn">覆盖</button>
                <button class="btn btn-warning" id="addNewDuplicateBtn">新增</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 系统版本号 - 每次修改自动更新
        const SYSTEM_VERSION = "2.4.1";
        document.getElementById('version').textContent = SYSTEM_VERSION;
        
        // 国产设备制造商列表（可扩展）
        const domesticManufacturers = [
            "HUAWEI", "华为", "中兴", "zte", "Ruijie", "锐捷", "Phytium", "飞腾", 
            "Lenovo", "联想", "Inspur", "浪潮", "曙光", "Sugon", "BITLAND", "Bitland",
            "PANTHERA", "DONGGUAN HUARONG", "TP-LINK", "普联", "Pantum", "奔图",
            "Hefei Bitland", "LCFC", "G-PRO", "COMPAL", "EliteGroup", "Micro-Star",
            "Zhuhai Pantum", "Kyocera", "LANXUM"
        ];
        
        // 高风险服务/端口
        const highRiskServices = [
            {port: 21, service: "FTP", risk: "高危"},
            {port: 22, service: "SSH", risk: "中危"},
            {port: 23, service: "Telnet", risk: "高危"},
            {port: 135, service: "RPC", risk: "高危"},
            {port: 139, service: "NetBIOS", risk: "高危"},
            {port: 445, service: "SMB", risk: "高危"},
            {port: 3389, service: "RDP", risk: "高危"},
            {port: 1433, service: "MSSQL", risk: "高危"},
            {port: 3306, service: "MySQL", risk: "中危"},
            {port: 5900, service: "VNC", risk: "高危"},
            {port: 8080, service: "HTTP代理", risk: "中危"},
            {port: 9000, service: "网络打印机", risk: "低危"}
        ];
        
        // 设备数据存储
        let devices = [];
        let scanData = [];
        let charts = {};
        let currentEditIndex = -1;
        
        // 重复数据处理相关变量
        let duplicateDevices = [];
        let currentDuplicateIndex = 0;
        let duplicateResolveCallback = null;
        
        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            loadFromLocalStorage();
            updateTime();
        });
        
        // 初始化应用
        function initApp() {
            // 设置更新时间
            updateTimestamp();
            
            // 绑定文件上传事件监听器
            document.getElementById('uploadDeviceFileBtn').addEventListener('click', () => {
                document.getElementById('deviceFileInput').click();
            });
            
            document.getElementById('uploadScanFileBtn').addEventListener('click', () => {
                document.getElementById('scanFileInput').click();
            });
            
            // 绑定文件选择事件
            document.getElementById('deviceFileInput').addEventListener('change', function(e) {
                handleFileUpload(e, 'device');
            });
            
            document.getElementById('scanFileInput').addEventListener('change', function(e) {
                handleFileUpload(e, 'scan');
            });
            
            // 绑定其他按钮事件
            document.getElementById('loadDemoDataBtn').addEventListener('click', loadDemoData);
            document.getElementById('exportHtmlBtn').addEventListener('click', exportHtmlReport);
            document.getElementById('exportDocBtn').addEventListener('click', exportDocReport);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', showImportModal);
            document.getElementById('clearDataBtn').addEventListener('click', showConfirmClearModal);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            
            // 绑定筛选器事件
            document.getElementById('searchInput').addEventListener('input', filterDevices);
            document.getElementById('statusFilter').addEventListener('change', filterDevices);
            document.getElementById('deviceTypeFilter').addEventListener('change', filterDevices);
            document.getElementById('domesticFilter').addEventListener('change', filterDevices);
            document.getElementById('riskFilter').addEventListener('change', filterDevices);
            
            // 模态框相关事件
            document.getElementById('closeEditModalBtn').addEventListener('click', () => hideModal('editModal'));
            document.getElementById('cancelEditBtn').addEventListener('click', () => hideModal('editModal'));
            document.getElementById('saveEditBtn').addEventListener('click', saveDeviceEdit);
            
            document.getElementById('closeStatsModalBtn').addEventListener('click', () => hideModal('statsModal'));
            document.getElementById('closeStatsBtn').addEventListener('click', () => hideModal('statsModal'));
            
            document.getElementById('closeImportModalBtn').addEventListener('click', () => hideModal('importModal'));
            document.getElementById('cancelImportBtn').addEventListener('click', () => hideModal('importModal'));
            document.getElementById('confirmImportBtn').addEventListener('click', confirmImport);
            document.getElementById('importFileInputModal').addEventListener('change', previewImportData);
            
            // 清除数据模态框事件
            document.getElementById('closeConfirmClearModalBtn').addEventListener('click', () => hideModal('confirmClearModal'));
            document.getElementById('cancelClearBtn').addEventListener('click', () => hideModal('confirmClearModal'));
            document.getElementById('confirmClearBtn').addEventListener('click', clearAllData);
            
            // 重复数据模态框事件
            document.getElementById('closeDuplicateModalBtn').addEventListener('click', () => hideModal('duplicateModal'));
            document.getElementById('skipDuplicateBtn').addEventListener('click', skipDuplicate);
            document.getElementById('overwriteDuplicateBtn').addEventListener('click', overwriteDuplicate);
            document.getElementById('addNewDuplicateBtn').addEventListener('click', addNewDuplicate);
            
            // 统计按钮事件
            document.getElementById('showOnlineStatsBtn').addEventListener('click', () => showStats('status'));
            document.getElementById('showRiskStatsBtn').addEventListener('click', () => showStats('risk'));
            document.getElementById('showDeviceTypesBtn').addEventListener('click', () => showStats('deviceType'));
            document.getElementById('showDomesticStatsBtn').addEventListener('click', () => showStats('domestic'));
            
            // 初始化图表
            initCharts();
        }
        
        // 初始化图表
        function initCharts() {
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            const deviceTypeCtx = document.getElementById('deviceTypeChart').getContext('2d');
            const domesticCtx = document.getElementById('domesticChart').getContext('2d');
            
            // 如果Canvas元素不存在，则跳过
            if (!statusCtx || !riskCtx || !deviceTypeCtx || !domesticCtx) {
                console.error('Canvas元素未找到');
                return;
            }
            
            charts.statusChart = new Chart(statusCtx, {
                type: 'bar',
                data: {
                    labels: ['在线设备', '离线设备'],
                    datasets: [{
                        label: '设备数量',
                        data: [0, 0],
                        backgroundColor: ['#34a853', '#ea4335']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
            
            charts.riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['高风险', '中风险', '低风险', '无风险'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#ea4335', '#f9ab00', '#34a853', '#9aa0a6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            charts.deviceTypeChart = new Chart(deviceTypeCtx, {
                type: 'pie',
                data: {
                    labels: ['计算机', '打印机', '路由器', '交换机', '服务器', '其他'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0, 0],
                        backgroundColor: ['#1a73e8', '#34a853', '#f9ab00', '#ea4335', '#9aa0a6', '#673ab7']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
            
            charts.domesticChart = new Chart(domesticCtx, {
                type: 'pie',
                data: {
                    labels: ['国产设备', '非国产设备'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#2e7d32', '#c2185b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // 处理文件上传
        function handleFileUpload(event, fileType) {
            const file = event.target.files[0];
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            // 检查文件类型
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('请选择CSV文件');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    if (fileType === 'device') {
                        handleDeviceCSVUpload(content);
                    } else if (fileType === 'scan') {
                        handleScanCSVUpload(content);
                    }
                    
                } catch (error) {
                    console.error('解析CSV文件时出错:', error);
                    alert('解析CSV文件时出错，请检查文件格式');
                }
                
                // 重置文件输入
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('读取文件失败');
                event.target.value = '';
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // 处理设备CSV上传（添加式导入）
        function handleDeviceCSVUpload(content) {
            const lines = content.split('\n');
            if (lines.length < 2) {
                alert('CSV文件内容为空或格式不正确');
                return;
            }
            
            // 第一行是标题行
            const headers = lines[0].split('\t');
            
            const newDevices = [];
            const duplicateCandidates = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                // 处理制表符分隔的值
                const values = line.split('\t');
                
                // 确保有足够的数据列
                if (values.length < 5) continue;
                
                // 状态映射
                let status = values[0] || '未知';
                if (status === '确定') status = '在线';
                if (status === '关机') status = '离线';
                
                const device = {
                    status: status,
                    name: values[1] || values[2] || '未知设备',
                    ip: values[2] || '',
                    radmin: values[3] || '',
                    http: values[4] || '',
                    https: values[5] || '',
                    ftp: values[6] || '',
                    rdp: values[7] || '',
                    sharedFolder: values[8] || '',
                    sharedPrinter: values[9] || '',
                    netbiosGroup: values[10] || '',
                    manufacturer: values[11] || '',
                    mac: values[12] || '00:00:00:00:00:00',
                    user: values[13] || '',
                    date: values[14] || '',
                    notes: values[15] || ''
                };
                
                // 判断设备类型
                device.type = determineDeviceType(device);
                
                // 判断是否为国产设备
                device.isDomestic = isDomesticDevice(device.manufacturer);
                device.domesticText = device.isDomestic ? '是' : '否';
                
                // 检查是否与现有设备重复
                const duplicateInfo = checkDeviceDuplicate(device);
                
                if (duplicateInfo.hasDuplicate) {
                    duplicateCandidates.push({
                        newDevice: device,
                        duplicateInfo: duplicateInfo
                    });
                } else {
                    newDevices.push(device);
                }
            }
            
            console.log(`解析到 ${newDevices.length + duplicateCandidates.length} 个设备，其中 ${duplicateCandidates.length} 个需要确认`);
            
            // 先添加无重复的设备
            if (newDevices.length > 0) {
                devices.push(...newDevices);
                alert(`成功添加 ${newDevices.length} 个设备`);
            }
            
            // 处理需要确认的重复设备
            if (duplicateCandidates.length > 0) {
                duplicateDevices = duplicateCandidates;
                currentDuplicateIndex = 0;
                showDuplicateModal();
            } else {
                // 合并数据并更新UI
                mergeDataAndUpdate();
                saveToLocalStorage();
            }
        }
        
        // 处理扫描CSV上传（添加式导入）
        function handleScanCSVUpload(content) {
            const lines = content.split('\n');
            if (lines.length < 2) {
                alert('CSV文件内容为空或格式不正确');
                return;
            }
            
            const newScanData = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line === '') continue;
                
                // 处理CSV行，处理可能包含逗号的字段
                const values = parseCSVLine(line);
                
                if (values.length < 4) continue;
                
                const scanItem = {
                    ip: values[0] || '',
                    hostname: values[1] || '',
                    type: values[2] || '',
                    detail: values[3] || ''
                };
                
                newScanData.push(scanItem);
            }
            
            // 添加新的扫描数据（覆盖重复的）
            newScanData.forEach(newScan => {
                // 查找是否已存在相同的扫描记录（IP、类型、详情都相同）
                const existingIndex = scanData.findIndex(scan => 
                    scan.ip === newScan.ip && 
                    scan.type === newScan.type && 
                    scan.detail === newScan.detail
                );
                
                if (existingIndex !== -1) {
                    // 覆盖已存在的记录
                    scanData[existingIndex] = newScan;
                } else {
                    // 添加新记录
                    scanData.push(newScan);
                }
            });
            
            console.log(`解析到 ${newScanData.length} 条扫描记录`);
            alert(`成功添加/更新 ${newScanData.length} 条扫描记录`);
            
            // 合并数据并更新UI
            mergeDataAndUpdate();
            saveToLocalStorage();
        }
        
        // 检查设备是否重复
        function checkDeviceDuplicate(newDevice) {
            const result = {
                hasDuplicate: false,
                ipDuplicate: false,
                macDuplicate: false,
                duplicateIndex: -1,
                duplicateDevice: null
            };
            
            // 检查IP重复
            const ipDuplicateIndex = devices.findIndex(device => device.ip === newDevice.ip);
            if (ipDuplicateIndex !== -1) {
                result.hasDuplicate = true;
                result.ipDuplicate = true;
                result.duplicateIndex = ipDuplicateIndex;
                result.duplicateDevice = devices[ipDuplicateIndex];
                
                // 检查MAC是否相同
                if (devices[ipDuplicateIndex].mac === newDevice.mac) {
                    result.macDuplicate = true;
                }
                
                return result;
            }
            
            // 检查MAC重复
            const macDuplicateIndex = devices.findIndex(device => device.mac === newDevice.mac);
            if (macDuplicateIndex !== -1) {
                result.hasDuplicate = true;
                result.macDuplicate = true;
                result.duplicateIndex = macDuplicateIndex;
                result.duplicateDevice = devices[macDuplicateIndex];
                
                return result;
            }
            
            return result;
        }
        
        // 显示重复数据确认模态框
        function showDuplicateModal() {
            if (currentDuplicateIndex >= duplicateDevices.length) {
                // 所有重复设备处理完毕
                hideModal('duplicateModal');
                
                // 合并数据并更新UI
                mergeDataAndUpdate();
                saveToLocalStorage();
                
                alert(`重复数据处理完成，共处理 ${duplicateDevices.length} 个重复设备`);
                return;
            }
            
            const duplicateItem = duplicateDevices[currentDuplicateIndex];
            const newDevice = duplicateItem.newDevice;
            const duplicateInfo = duplicateItem.duplicateInfo;
            const existingDevice = duplicateInfo.duplicateDevice;
            
            let message = '';
            if (duplicateInfo.ipDuplicate && duplicateInfo.macDuplicate) {
                message = `
                    <p>发现完全重复的设备：</p>
                    <p><strong>IP地址:</strong> ${newDevice.ip}</p>
                    <p><strong>MAC地址:</strong> ${newDevice.mac}</p>
                    <p><strong>设备名称:</strong> ${newDevice.name}</p>
                    <hr>
                    <p>现有设备信息：</p>
                    <p><strong>设备名称:</strong> ${existingDevice.name}</p>
                    <p><strong>状态:</strong> ${existingDevice.status}</p>
                    <p><strong>设备类型:</strong> ${existingDevice.type}</p>
                    <p>请选择处理方式：</p>
                `;
            } else if (duplicateInfo.ipDuplicate && !duplicateInfo.macDuplicate) {
                message = `
                    <p>发现IP地址重复但MAC地址不同的设备：</p>
                    <p><strong>IP地址:</strong> ${newDevice.ip}</p>
                    <p><strong>新设备MAC:</strong> ${newDevice.mac}</p>
                    <p><strong>现有设备MAC:</strong> ${existingDevice.mac}</p>
                    <hr>
                    <p>现有设备信息：</p>
                    <p><strong>设备名称:</strong> ${existingDevice.name}</p>
                    <p><strong>状态:</strong> ${existingDevice.status}</p>
                    <p><strong>设备类型:</strong> ${existingDevice.type}</p>
                    <p>请选择处理方式：</p>
                `;
            } else if (!duplicateInfo.ipDuplicate && duplicateInfo.macDuplicate) {
                message = `
                    <p>发现MAC地址重复但IP地址不同的设备：</p>
                    <p><strong>MAC地址:</strong> ${newDevice.mac}</p>
                    <p><strong>新设备IP:</strong> ${newDevice.ip}</p>
                    <p><strong>现有设备IP:</strong> ${existingDevice.ip}</p>
                    <hr>
                    <p>现有设备信息：</p>
                    <p><strong>设备名称:</strong> ${existingDevice.name}</p>
                    <p><strong>状态:</strong> ${existingDevice.status}</p>
                    <p><strong>设备类型:</strong> ${existingDevice.type}</p>
                    <p>请选择处理方式：</p>
                `;
            }
            
            document.getElementById('duplicateContent').innerHTML = message;
            showModal('duplicateModal');
        }
        
        // 跳过重复设备
        function skipDuplicate() {
            currentDuplicateIndex++;
            showDuplicateModal();
        }
        
        // 覆盖重复设备
        function overwriteDuplicate() {
            const duplicateItem = duplicateDevices[currentDuplicateIndex];
            const newDevice = duplicateItem.newDevice;
            const duplicateInfo = duplicateItem.duplicateInfo;
            
            // 覆盖现有设备
            devices[duplicateInfo.duplicateIndex] = newDevice;
            
            currentDuplicateIndex++;
            showDuplicateModal();
        }
        
        // 新增重复设备（作为新设备添加）
        function addNewDuplicate() {
            const duplicateItem = duplicateDevices[currentDuplicateIndex];
            const newDevice = duplicateItem.newDevice;
            
            // 作为新设备添加
            devices.push(newDevice);
            
            currentDuplicateIndex++;
            showDuplicateModal();
        }
        
        // 解析CSV行，处理引号和逗号
        function parseCSVLine(line) {
            const values = [];
            let currentValue = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    // 遇到引号，切换状态
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    // 遇到逗号且不在引号内，结束当前字段
                    values.push(currentValue.trim());
                    currentValue = '';
                } else {
                    // 添加到当前字段
                    currentValue += char;
                }
            }
            
            // 添加最后一个字段
            values.push(currentValue.trim());
            
            return values;
        }
        
        // 合并数据并更新UI
        function mergeDataAndUpdate() {
            // 为每个设备添加扫描信息
            devices.forEach(device => {
                device.openServices = [];
                device.openPorts = [];
                device.securityRisk = '无风险';
                
                // 查找该设备的扫描信息
                const deviceScans = scanData.filter(scan => scan.ip === device.ip);
                
                deviceScans.forEach(scan => {
                    // 提取端口信息
                    const portMatch = scan.detail.match(/\[(\d+)\]/);
                    if (portMatch) {
                        const port = parseInt(portMatch[1]);
                        device.openPorts.push(port);
                        
                        // 查找对应的服务
                        const service = highRiskServices.find(s => s.port === port);
                        if (service) {
                            device.openServices.push(`${service.service}(${port})`);
                        } else {
                            device.openServices.push(`端口${port}`);
                        }
                    }
                    
                    // 提取服务信息
                    if (scan.type.includes('HTTP') || scan.detail.includes('HTTP')) {
                        device.openServices.push('HTTP服务');
                    }
                    if (scan.type.includes('FTP') || scan.detail.includes('FTP')) {
                        device.openServices.push('FTP服务');
                    }
                    if (scan.type.includes('SNMP') || scan.detail.includes('SNMP')) {
                        device.openServices.push('SNMP服务');
                    }
                });
                
                // 去重
                device.openServices = [...new Set(device.openServices)];
                device.openPorts = [...new Set(device.openPorts)];
                
                // 评估安全风险
                device.securityRisk = evaluateSecurityRisk(device);
            });
            
            // 更新UI
            updateDeviceTable();
            updateCharts();
            updateStatusIndicators();
        }
        
        // 判断设备类型
        function determineDeviceType(device) {
            if (!device.manufacturer && !device.name) return '其他';
            
            const manufacturer = (device.manufacturer || '').toUpperCase();
            const name = (device.name || '').toUpperCase();
            
            if (manufacturer.includes('PRINTER') || manufacturer.includes('打印') || 
                name.includes('PRINTER') || name.includes('打印') ||
                manufacturer.includes('BROTHER') || manufacturer.includes('CANON') || 
                manufacturer.includes('PANTUM') || manufacturer.includes('HP') ||
                manufacturer.includes('KYOCERA') || manufacturer.includes('LANXUM')) {
                return '打印机';
            } else if (manufacturer.includes('ROUTER') || manufacturer.includes('路由') ||
                      manufacturer.includes('TP-LINK') || manufacturer.includes('HUAWEI') ||
                      manufacturer.includes('ZTE') || manufacturer.includes('Ruijie')) {
                return '路由器';
            } else if (manufacturer.includes('SWITCH') || manufacturer.includes('交换')) {
                return '交换机';
            } else if (manufacturer.includes('SERVER') || name.includes('SERVER') ||
                      name.includes('WIN-') || name.includes('DESKTOP-')) {
                return '服务器';
            } else if (device.name.includes('PC') || device.name.includes('计算机') ||
                      manufacturer.includes('COMPUTER') || manufacturer.includes('LENOVO') ||
                      manufacturer.includes('DELL') || manufacturer.includes('HP') ||
                      manufacturer.includes('MSI') || manufacturer.includes('GIGA-BYTE')) {
                return '计算机';
            } else {
                return '其他';
            }
        }
        
        // 判断是否为国产设备
        function isDomesticDevice(manufacturer) {
            if (!manufacturer) return false;
            
            const upperManufacturer = manufacturer.toUpperCase();
            return domesticManufacturers.some(domestic => upperManufacturer.includes(domestic.toUpperCase()));
        }
        
        // 评估安全风险
        function evaluateSecurityRisk(device) {
            let riskScore = 0;
            
            // 检查开放的高风险端口
            device.openPorts.forEach(port => {
                const riskService = highRiskServices.find(s => s.port === port);
                if (riskService) {
                    if (riskService.risk === '高危') riskScore += 3;
                    else if (riskService.risk === '中危') riskScore += 2;
                    else riskScore += 1;
                }
            });
            
            // 检查其他风险因素
            if (device.sharedFolder && device.sharedFolder !== '') riskScore += 2;
            if (device.sharedPrinter && device.sharedPrinter !== '') riskScore += 1;
            if (device.rdp && device.rdp !== '') riskScore += 3;
            if (device.ftp && device.ftp !== '') riskScore += 2;
            if (device.http && device.http !== '') riskScore += 1;
            if (device.https && device.https !== '') riskScore += 1;
            
            // 确定风险级别
            if (riskScore >= 5) return '高风险';
            else if (riskScore >= 3) return '中风险';
            else if (riskScore >= 1) return '低风险';
            else return '无风险';
        }
        
        // 更新设备表格（按IP从小到大排序）
        function updateDeviceTable() {
            const tableBody = document.getElementById('deviceTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            // 获取筛选条件
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const deviceTypeFilter = document.getElementById('deviceTypeFilter').value;
            const domesticFilter = document.getElementById('domesticFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;
            
            // 筛选设备
            let filteredDevices = devices;
            
            if (searchTerm) {
                filteredDevices = filteredDevices.filter(device => 
                    // 扩大搜索范围
                    device.name.toLowerCase().includes(searchTerm) || 
                    device.ip.toLowerCase().includes(searchTerm) ||
                    device.mac.toLowerCase().includes(searchTerm) ||
                    device.status.toLowerCase().includes(searchTerm) ||
                    device.type.toLowerCase().includes(searchTerm) ||
                    device.domesticText.toLowerCase().includes(searchTerm) ||
                    device.openServices.join(', ').toLowerCase().includes(searchTerm) ||
                    device.securityRisk.toLowerCase().includes(searchTerm) ||
                    (device.notes && device.notes.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter) {
                filteredDevices = filteredDevices.filter(device => device.status === statusFilter);
            }
            
            if (deviceTypeFilter) {
                filteredDevices = filteredDevices.filter(device => device.type === deviceTypeFilter);
            }
            
            if (domesticFilter) {
                const isDomestic = domesticFilter === '国产';
                filteredDevices = filteredDevices.filter(device => 
                    (isDomestic && device.isDomestic) || (!isDomestic && !device.isDomestic)
                );
            }
            
            if (riskFilter) {
                filteredDevices = filteredDevices.filter(device => device.securityRisk === riskFilter);
            }
            
            // 按IP地址从小到大排序
            filteredDevices = sortDevicesByIP(filteredDevices);
            
            if (filteredDevices.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" style="text-align: center; padding: 30px;">暂无设备数据，请上传CSV文件或加载示例数据</td>`;
                tableBody.appendChild(row);
                return;
            }
            
            filteredDevices.forEach((device, index) => {
                const row = document.createElement('tr');
                
                // 根据风险级别设置行背景色
                if (device.securityRisk === '高风险') {
                    row.style.backgroundColor = '#ffebee';
                } else if (device.securityRisk === '中风险') {
                    row.style.backgroundColor = '#fff3e0';
                }
                
                // 状态显示
                let statusClass = 'status-unknown';
                if (device.status === '在线') statusClass = 'status-online';
                else if (device.status === '离线') statusClass = 'status-offline';
                
                // 设备类型显示
                let deviceTypeClass = 'device-type-other';
                if (device.type === '计算机') deviceTypeClass = 'device-type-computer';
                else if (device.type === '打印机') deviceTypeClass = 'device-type-printer';
                else if (device.type === '路由器') deviceTypeClass = 'device-type-router';
                else if (device.type === '交换机') deviceTypeClass = 'device-type-switch';
                else if (device.type === '服务器') deviceTypeClass = 'device-type-server';
                
                // 国产标识显示
                let domesticClass = device.isDomestic ? 'domestic-yes' : 'domestic-no';
                let domesticText = device.isDomestic ? '国产' : '非国产';
                
                // 安全风险显示
                let riskClass = 'risk-none';
                if (device.securityRisk === '高风险') riskClass = 'risk-high';
                else if (device.securityRisk === '中风险') riskClass = 'risk-medium';
                else if (device.securityRisk === '低风险') riskClass = 'risk-low';
                
                row.innerHTML = `
                    <td><span class="${statusClass}">${device.status}</span></td>
                    <td title="${escapeHtml(device.name)}">${escapeHtml(device.name)}</td>
                    <td title="${escapeHtml(device.ip)}">${escapeHtml(device.ip)}</td>
                    <td><span class="device-type-badge ${deviceTypeClass}" title="${escapeHtml(device.type)}">${escapeHtml(device.type)}</span></td>
                    <td title="${escapeHtml(device.mac)}">${escapeHtml(device.mac)}</td>
                    <td><span class="domestic-badge ${domesticClass}">${domesticText}</span></td>
                    <td title="${escapeHtml(device.openServices.join(', ') || '无')}">${escapeHtml(device.openServices.join(', ') || '无')}</td>
                    <td><span class="${riskClass}">${device.securityRisk}</span></td>
                    <td title="${escapeHtml(device.notes || '无')}">${escapeHtml(device.notes || '无')}</td>
                    <td>
                        <button class="action-btn edit-btn" data-index="${index}">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // 为编辑按钮添加事件监听器
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    editDevice(index);
                });
            });
        }
        
        // 按IP地址从小到大排序
        function sortDevicesByIP(devices) {
            return devices.sort((a, b) => {
                const ipToNumber = (ip) => {
                    if (!ip) return 0;
                    const parts = ip.split('.');
                    if (parts.length !== 4) return 0;
                    return parts.reduce((acc, part, index) => {
                        return acc + parseInt(part || 0) * Math.pow(256, 3 - index);
                    }, 0);
                };
                
                return ipToNumber(a.ip) - ipToNumber(b.ip);
            });
        }
        
        // 更新图表
        function updateCharts() {
            if (!charts.statusChart || !devices.length) return;
            
            // 统计设备状态 - 只统计在线和离线
            const onlineCount = devices.filter(d => d.status === '在线').length;
            const offlineCount = devices.filter(d => d.status === '离线').length;
            
            // 统计安全风险
            const highRiskCount = devices.filter(d => d.securityRisk === '高风险').length;
            const mediumRiskCount = devices.filter(d => d.securityRisk === '中风险').length;
            const lowRiskCount = devices.filter(d => d.securityRisk === '低风险').length;
            const noRiskCount = devices.filter(d => d.securityRisk === '无风险').length;
            
            // 统计设备类型
            const typeCounts = {
                '计算机': devices.filter(d => d.type === '计算机').length,
                '打印机': devices.filter(d => d.type === '打印机').length,
                '路由器': devices.filter(d => d.type === '路由器').length,
                '交换机': devices.filter(d => d.type === '交换机').length,
                '服务器': devices.filter(d => d.type === '服务器').length,
                '其他': devices.filter(d => d.type === '其他').length
            };
            
            // 统计国产设备比例
            const domesticCount = devices.filter(d => d.isDomestic).length;
            const foreignCount = devices.length - domesticCount;
            
            // 更新设备状态图表
            charts.statusChart.data.datasets[0].data = [onlineCount, offlineCount];
            charts.statusChart.update();
            
            // 更新安全风险图表
            charts.riskChart.data.datasets[0].data = [highRiskCount, mediumRiskCount, lowRiskCount, noRiskCount];
            charts.riskChart.update();
            
            // 更新设备类型图表
            charts.deviceTypeChart.data.datasets[0].data = [
                typeCounts['计算机'],
                typeCounts['打印机'],
                typeCounts['路由器'],
                typeCounts['交换机'],
                typeCounts['服务器'],
                typeCounts['其他']
            ];
            charts.deviceTypeChart.update();
            
            // 更新国产设备图表
            charts.domesticChart.data.datasets[0].data = [domesticCount, foreignCount];
            charts.domesticChart.update();
        }
        
        // 更新状态指示器
        function updateStatusIndicators() {
            const onlineCount = devices.filter(d => d.status === '在线').length;
            const offlineCount = devices.filter(d => d.status === '离线').length;
            const domesticCount = devices.filter(d => d.isDomestic).length;
            const domesticPercent = devices.length > 0 ? Math.round((domesticCount / devices.length) * 100) : 0;
            
            document.getElementById('online-count').textContent = onlineCount;
            document.getElementById('offline-count').textContent = offlineCount;
            document.getElementById('domestic-percent').textContent = `${domesticPercent}%`;
        }
        
        // 编辑设备
        function editDevice(index) {
            if (index < 0 || index >= devices.length) return;
            
            const device = devices[index];
            currentEditIndex = index;
            
            document.getElementById('editIndex').value = index;
            document.getElementById('editName').value = device.name;
            document.getElementById('editIp').value = device.ip;
            document.getElementById('editType').value = device.type;
            document.getElementById('editMac').value = device.mac;
            document.getElementById('editDomestic').value = device.domesticText;
            document.getElementById('editStatus').value = device.status;
            document.getElementById('editNotes').value = device.notes || '';
            
            showModal('editModal');
        }
        
        // 保存设备编辑
        function saveDeviceEdit() {
            if (currentEditIndex < 0 || currentEditIndex >= devices.length) return;
            
            const device = devices[currentEditIndex];
            
            device.name = document.getElementById('editName').value;
            device.ip = document.getElementById('editIp').value;
            device.type = document.getElementById('editType').value;
            device.mac = document.getElementById('editMac').value;
            device.domesticText = document.getElementById('editDomestic').value;
            device.isDomestic = device.domesticText === '是';
            device.status = document.getElementById('editStatus').value;
            device.notes = document.getElementById('editNotes').value;
            
            // 更新UI
            updateDeviceTable();
            updateCharts();
            updateStatusIndicators();
            
            // 保存到本地存储
            saveToLocalStorage();
            
            hideModal('editModal');
            currentEditIndex = -1;
        }
        
        // 显示统计详情
        function showStats(type) {
            let title = '';
            let content = '';
            
            if (type === 'status') {
                title = '设备状态统计详情';
                const onlineCount = devices.filter(d => d.status === '在线').length;
                const offlineCount = devices.filter(d => d.status === '离线').length;
                
                content = `
                    <h4>设备状态分布</h4>
                    <ul>
                        <li><strong>在线设备:</strong> ${onlineCount} 台 (${devices.length > 0 ? Math.round((onlineCount/devices.length)*100) : 0}%)</li>
                        <li><strong>离线设备:</strong> ${offlineCount} 台 (${devices.length > 0 ? Math.round((offlineCount/devices.length)*100) : 0}%)</li>
                    </ul>
                    
                    <h4>在线设备详情</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f1f3f4;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">设备名称</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">IP地址</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">类型</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${devices.filter(d => d.status === '在线').map(d => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.name)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.ip)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.type)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (type === 'risk') {
                title = '安全风险分布详情';
                const highRiskDevices = devices.filter(d => d.securityRisk === '高风险');
                const mediumRiskDevices = devices.filter(d => d.securityRisk === '中风险');
                const lowRiskDevices = devices.filter(d => d.securityRisk === '低风险');
                const noRiskDevices = devices.filter(d => d.securityRisk === '无风险');
                
                content = `
                    <h4>安全风险统计</h4>
                    <ul>
                        <li><strong>高风险设备:</strong> ${highRiskDevices.length} 台</li>
                        <li><strong>中风险设备:</strong> ${mediumRiskDevices.length} 台</li>
                        <li><strong>低风险设备:</strong> ${lowRiskDevices.length} 台</li>
                        <li><strong>无风险设备:</strong> ${noRiskDevices.length} 台</li>
                    </ul>
                    
                    <h4>高风险设备列表</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${highRiskDevices.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background-color: #ffebee;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">设备名称</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">IP地址</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">风险原因</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${highRiskDevices.map(d => {
                                        let riskReasons = [];
                                        if (d.openPorts && d.openPorts.length > 0) {
                                            d.openPorts.forEach(port => {
                                                const riskService = highRiskServices.find(s => s.port === port);
                                                if (riskService && riskService.risk === '高危') {
                                                    riskReasons.push(`${riskService.service}端口(${port})`);
                                                }
                                            });
                                        }
                                        if (d.rdp && d.rdp !== '') riskReasons.push('RDP服务');
                                        if (riskReasons.length === 0) riskReasons.push('未知风险');
                                        
                                        return `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.name)}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.ip)}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(riskReasons.join(', '))}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        ` : '<p>无高风险设备</p>'}
                    </div>
                    
                    <h4>安全建议</h4>
                    <ul>
                        <li>关闭不必要的端口和服务</li>
                        <li>及时更新设备固件和系统补丁</li>
                        <li>为网络设备设置强密码</li>
                        <li>限制网络共享访问权限</li>
                        <li>定期进行安全扫描和风险评估</li>
                    </ul>
                `;
            } else if (type === 'deviceType') {
                title = '设备类型分布详情';
                
                // 统计设备类型
                const typeCounts = {
                    '计算机': devices.filter(d => d.type === '计算机').length,
                    '打印机': devices.filter(d => d.type === '打印机').length,
                    '路由器': devices.filter(d => d.type === '路由器').length,
                    '交换机': devices.filter(d => d.type === '交换机').length,
                    '服务器': devices.filter(d => d.type === '服务器').length,
                    '其他': devices.filter(d => d.type === '其他').length
                };
                
                content = `
                    <h4>设备类型统计</h4>
                    <ul>
                        <li><strong>计算机:</strong> ${typeCounts['计算机']} 台 (${devices.length > 0 ? Math.round((typeCounts['计算机']/devices.length)*100) : 0}%)</li>
                        <li><strong>打印机:</strong> ${typeCounts['打印机']} 台 (${devices.length > 0 ? Math.round((typeCounts['打印机']/devices.length)*100) : 0}%)</li>
                        <li><strong>路由器:</strong> ${typeCounts['路由器']} 台 (${devices.length > 0 ? Math.round((typeCounts['路由器']/devices.length)*100) : 0}%)</li>
                        <li><strong>交换机:</strong> ${typeCounts['交换机']} 台 (${devices.length > 0 ? Math.round((typeCounts['交换机']/devices.length)*100) : 0}%)</li>
                        <li><strong>服务器:</strong> ${typeCounts['服务器']} 台 (${devices.length > 0 ? Math.round((typeCounts['服务器']/devices.length)*100) : 0}%)</li>
                        <li><strong>其他设备:</strong> ${typeCounts['其他']} 台 (${devices.length > 0 ? Math.round((typeCounts['其他']/devices.length)*100) : 0}%)</li>
                    </ul>
                    
                    <h4>网络设备详情（路由器/交换机）</h4>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #f1f3f4;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">设备名称</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">IP地址</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">MAC地址</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">状态</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${devices.filter(d => d.type === '路由器' || d.type === '交换机').map(d => `
                                    <tr>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.name)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.ip)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.mac)}</td>
                                        <td style="padding: 8px; border: 1px solid #ddd;">${escapeHtml(d.status)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (type === 'domestic') {
                title = '国产设备比例详情';
                const domesticCount = devices.filter(d => d.isDomestic).length;
                const foreignCount = devices.length - domesticCount;
                const domesticPercent = devices.length > 0 ? Math.round((domesticCount / devices.length) * 100) : 0;
                
                content = `
                    <h4>国产化统计</h4>
                    <ul>
                        <li><strong>国产设备:</strong> ${domesticCount} 台 (${domesticPercent}%)</li>
                        <li><strong>非国产设备:</strong> ${foreignCount} 台 (${100 - domesticPercent}%)</li>
                    </ul>
                    
                    <h4>国产设备安全状况</h4>
                    <p>国产设备中，高风险设备: ${devices.filter(d => d.isDomestic && d.securityRisk === '高风险').length} 台，中风险设备: ${devices.filter(d => d.isDomestic && d.securityRisk === '中风险').length} 台，低风险设备: ${devices.filter(d => d.isDomestic && d.securityRisk === '低风险').length} 台。</p>
                    
                    <h4>非国产设备安全状况</h4>
                    <p>非国产设备中，高风险设备: ${devices.filter(d => !d.isDomestic && d.securityRisk === '高风险').length} 台，中风险设备: ${devices.filter(d => !d.isDomestic && d.securityRisk === '中风险').length} 台，低风险设备: ${devices.filter(d => !d.isDomestic && d.securityRisk === '低风险').length} 台。</p>
                `;
            }
            
            document.getElementById('statsTitle').textContent = title;
            document.getElementById('statsContent').innerHTML = content;
            showModal('statsModal');
        }
        
        // 加载示例数据
        function loadDemoData() {
            // 创建示例设备数据
            devices = [
                {
                    status: '在线',
                    name: 'USER-C1EQR43343',
                    ip: '10.96.76.3',
                    type: '计算机',
                    mac: 'E0:BE:03:12:C9:52',
                    isDomestic: true,
                    domesticText: '是',
                    openServices: ['SMTP(25)', 'POP3(110)', 'imap(143)', 'NetBIOS(139)', 'SMB(445)'],
                    openPorts: [25, 110, 143, 139, 445],
                    securityRisk: '中风险',
                    notes: '用户办公电脑'
                },
                {
                    status: '在线',
                    name: 'GXXC-PC',
                    ip: '10.96.76.6',
                    type: '计算机',
                    mac: '2C:1A:01:9B:0F:04',
                    isDomestic: true,
                    domesticText: '是',
                    openServices: ['SMTP(25)', 'POP3(110)', 'imap(143)', 'SSH(22)', 'NetBIOS(139)', 'SMB(445)'],
                    openPorts: [25, 110, 143, 22, 139, 445],
                    securityRisk: '高风险',
                    notes: '华为台式机'
                },
                {
                    status: '在线',
                    name: 'BRNB422008E8651',
                    ip: '10.96.76.29',
                    type: '打印机',
                    mac: 'B4:22:00:8E:86:51',
                    isDomestic: false,
                    domesticText: '否',
                    openServices: ['FTP(21)', 'Telnet(23)', 'HTTP(80)', 'HTTPS(443)'],
                    openPorts: [21, 23, 80, 443],
                    securityRisk: '中风险',
                    notes: '兄弟打印机'
                },
                {
                    status: '在线',
                    name: '10.96.76.1',
                    ip: '10.96.76.1',
                    type: '路由器',
                    mac: '3C:C7:86:0C:CF:12',
                    isDomestic: true,
                    domesticText: '是',
                    openServices: ['Telnet(23)', 'SMTP(25)', 'POP3(110)', 'imap(143)'],
                    openPorts: [23, 25, 110, 143],
                    securityRisk: '高风险',
                    notes: '路由器设备'
                },
                {
                    status: '离线',
                    name: '10.96.76.11',
                    ip: '10.96.76.11',
                    type: '路由器',
                    mac: '50:FA:84:6F:49:EF',
                    isDomestic: true,
                    domesticText: '是',
                    openServices: [],
                    openPorts: [],
                    securityRisk: '无风险',
                    notes: 'TP-LINK路由器'
                },
                {
                    status: '在线',
                    name: 'DESKTOP-90EP1A7',
                    ip: '10.96.76.28',
                    type: '服务器',
                    mac: '70:B5:E8:28:E6:ED',
                    isDomestic: false,
                    domesticText: '否',
                    openServices: ['SMTP(25)', 'POP3(110)', 'imap(143)', 'NetBIOS(139)', 'RPC(135)', 'SMB(445)'],
                    openPorts: [25, 110, 143, 139, 135, 445],
                    securityRisk: '高风险',
                    notes: '戴尔服务器'
                },
                {
                    status: '离线',
                    name: 'SWITCH-01',
                    ip: '10.96.76.45',
                    type: '交换机',
                    mac: '70:85:C4:42:AF:85',
                    isDomestic: true,
                    domesticText: '是',
                    openServices: [],
                    openPorts: [],
                    securityRisk: '无风险',
                    notes: '核心交换机'
                }
            ];
            
            // 创建示例扫描数据
            scanData = [
                {ip: '10.96.76.3', hostname: 'USER-C1EQR43343', type: '端口', detail: 'SMTP [25]'},
                {ip: '10.96.76.3', hostname: 'USER-C1EQR43343', type: '端口', detail: 'POP3 [110]'},
                {ip: '10.96.76.3', hostname: 'USER-C1EQR43343', type: '端口', detail: 'imap [143]'},
                {ip: '10.96.76.3', hostname: 'USER-C1EQR43343', type: '端口', detail: 'Shared Network Folder [139]'},
                {ip: '10.96.76.3', hostname: 'USER-C1EQR43343', type: '端口', detail: 'Shared Network Folder [445]'},
                {ip: '10.96.76.6', hostname: '', type: '端口', detail: 'SSH [22]'},
                {ip: '10.96.76.6', hostname: '', type: '端口', detail: 'SMTP [25]'},
                {ip: '10.96.76.29', hostname: 'BRNB422008E8651', type: 'FTP Server', detail: 'FTP print service:V-1.13'},
                {ip: '10.96.76.29', hostname: 'BRNB422008E8651', type: '端口', detail: 'Telnet [23]'},
                {ip: '10.96.76.1', hostname: '', type: '端口', detail: 'Telnet [23]'},
                {ip: '10.96.76.28', hostname: 'DESKTOP-90EP1A7', type: '端口', detail: 'RPC [135]'}
            ];
            
            // 合并数据并更新UI
            mergeDataAndUpdate();
            
            // 保存到本地存储
            saveToLocalStorage();
            
            alert('示例数据加载成功！共加载了7个设备示例（含在线和离线设备）。');
        }
        
        // 导出HTML安全报告
        function exportHtmlReport() {
            if (devices.length === 0) {
                alert('没有数据可以导出，请先上传CSV文件或加载示例数据');
                return;
            }
            
            // 生成报告HTML内容
            const reportHtml = generateSecurityReport('html');
            
            // 创建下载链接
            const blob = new Blob([reportHtml], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `网络安全报告_${new Date().toISOString().slice(0, 10)}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('HTML安全报告导出成功！');
        }
        
        // 导出DOC安全报告
        function exportDocReport() {
            if (devices.length === 0) {
                alert('没有数据可以导出，请先上传CSV文件或加载示例数据');
                return;
            }
            
            // 生成报告HTML内容
            const reportHtml = generateSecurityReport('doc');
            
            // 创建下载链接（使用.doc扩展名）
            const blob = new Blob([reportHtml], { type: 'application/msword;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `网络安全报告_${new Date().toISOString().slice(0, 10)}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('DOC安全报告导出成功！');
        }
        
        // 生成安全报告
        function generateSecurityReport(format) {
            const now = new Date();
            const dateStr = now.toLocaleString('zh-CN');
            
            // 统计信息
            const totalDevices = devices.length;
            const onlineCount = devices.filter(d => d.status === '在线').length;
            const offlineCount = devices.filter(d => d.status === '离线').length;
            const domesticCount = devices.filter(d => d.isDomestic).length;
            const foreignCount = totalDevices - domesticCount;
            const domesticPercent = totalDevices > 0 ? Math.round((domesticCount / totalDevices) * 100) : 0;
            
            const highRiskCount = devices.filter(d => d.securityRisk === '高风险').length;
            const mediumRiskCount = devices.filter(d => d.securityRisk === '中风险').length;
            const lowRiskCount = devices.filter(d => d.securityRisk === '低风险').length;
            const noRiskCount = devices.filter(d => d.securityRisk === '无风险').length;
            
            // 设备类型统计
            const typeCounts = {
                '计算机': devices.filter(d => d.type === '计算机').length,
                '打印机': devices.filter(d => d.type === '打印机').length,
                '路由器': devices.filter(d => d.type === '路由器').length,
                '交换机': devices.filter(d => d.type === '交换机').length,
                '服务器': devices.filter(d => d.type === '服务器').length,
                '其他': devices.filter(d => d.type === '其他').length
            };
            
            // 高风险设备列表
            const highRiskDevices = devices.filter(d => d.securityRisk === '高风险');
            
            // 生成报告HTML
            let reportHtml = `
            <!DOCTYPE html>
            <html lang="zh-CN">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>网络安全分析报告</title>
                <style>
                    body { font-family: 'Microsoft YaHei', Arial, sans-serif; line-height: 1.6; color: #333; padding: 20px; }
                    h1, h2, h3 { color: #1a73e8; }
                    h1 { border-bottom: 2px solid #1a73e8; padding-bottom: 10px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .summary { background-color: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
                    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
                    .summary-item { background-color: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
                    .summary-value { font-size: 1.5rem; font-weight: bold; color: #1a73e8; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                    th { background-color: #1a73e8; color: white; }
                    tr:nth-child(even) { background-color: #f9f9f9; }
                    .risk-high { color: #ea4335; font-weight: bold; }
                    .risk-medium { color: #f9ab00; font-weight: bold; }
                    .risk-low { color: #34a853; font-weight: bold; }
                    .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #666; font-size: 0.9rem; }
                    @media print {
                        body { padding: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>网络安全分析报告</h1>
                    <p>生成时间: ${dateStr} | 系统版本: ${SYSTEM_VERSION} | 维护人员: msyg</p>
                </div>
                
                <div class="summary">
                    <h2>总体概况</h2>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div class="summary-value">${totalDevices}</div>
                            <div>设备总数</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${onlineCount}</div>
                            <div>在线设备</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${offlineCount}</div>
                            <div>离线设备</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${domesticPercent}%</div>
                            <div>国产化率</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value">${highRiskCount}</div>
                            <div>高风险设备</div>
                        </div>
                    </div>
                </div>
                
                <h2>设备状态统计</h2>
                <table>
                    <tr>
                        <th>状态</th>
                        <th>数量</th>
                        <th>百分比</th>
                    </tr>
                    <tr>
                        <td>在线设备</td>
                        <td>${onlineCount}</td>
                        <td>${totalDevices > 0 ? Math.round((onlineCount/totalDevices)*100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>离线设备</td>
                        <td>${offlineCount}</td>
                        <td>${totalDevices > 0 ? Math.round((offlineCount/totalDevices)*100) : 0}%</td>
                    </tr>
                </table>
                
                <h2>安全风险分布</h2>
                <table>
                    <tr>
                        <th>风险等级</th>
                        <th>数量</th>
                        <th>百分比</th>
                    </tr>
                    <tr>
                        <td><span class="risk-high">高风险</span></td>
                        <td>${highRiskCount}</td>
                        <td>${totalDevices > 0 ? Math.round((highRiskCount/totalDevices)*100) : 0}%</td>
                    </tr>
                    <tr>
                        <td><span class="risk-medium">中风险</span></td>
                        <td>${mediumRiskCount}</td>
                        <td>${totalDevices > 0 ? Math.round((mediumRiskCount/totalDevices)*100) : 0}%</td>
                    </tr>
                    <tr>
                        <td><span class="risk-low">低风险</span></td>
                        <td>${lowRiskCount}</td>
                        <td>${totalDevices > 0 ? Math.round((lowRiskCount/totalDevices)*100) : 0}%</td>
                    </tr>
                    <tr>
                        <td>无风险</td>
                        <td>${noRiskCount}</td>
                        <td>${totalDevices > 0 ? Math.round((noRiskCount/totalDevices)*100) : 0}%</td>
                    </tr>
                </table>
                
                <h2>设备类型分布</h2>
                <table>
                    <tr>
                        <th>设备类型</th>
                        <th>数量</th>
                        <th>百分比</th>
                    </tr>
                    ${Object.entries(typeCounts).map(([type, count]) => `
                        <tr>
                            <td>${type}</td>
                            <td>${count}</td>
                            <td>${totalDevices > 0 ? Math.round((count/totalDevices)*100) : 0}%</td>
                        </tr>
                    `).join('')}
                </table>
                
                <h2>高风险设备列表</h2>
                ${highRiskDevices.length > 0 ? `
                    <table>
                        <tr>
                            <th>设备名称</th>
                            <th>IP地址</th>
                            <th>设备类型</th>
                            <th>国产标识</th>
                            <th>开放服务</th>
                            <th>风险原因</th>
                        </tr>
                        ${highRiskDevices.map(device => {
                            let riskReasons = [];
                            if (device.openPorts && device.openPorts.length > 0) {
                                device.openPorts.forEach(port => {
                                    const riskService = highRiskServices.find(s => s.port === port);
                                    if (riskService && riskService.risk === '高危') {
                                        riskReasons.push(`${riskService.service}端口(${port})`);
                                    }
                                });
                            }
                            if (device.rdp && device.rdp !== '') riskReasons.push('RDP服务');
                            if (riskReasons.length === 0) riskReasons.push('未知风险');
                            
                            return `
                                <tr>
                                    <td>${escapeHtml(device.name)}</td>
                                    <td>${escapeHtml(device.ip)}</td>
                                    <td>${escapeHtml(device.type)}</td>
                                    <td>${device.isDomestic ? '国产' : '非国产'}</td>
                                    <td>${escapeHtml(device.openServices.join(', ') || '无')}</td>
                                    <td>${escapeHtml(riskReasons.join(', '))}</td>
                                </tr>
                            `;
                        }).join('')}
                    </table>
                ` : '<p>无高风险设备</p>'}
                
                <h2>安全建议</h2>
                <ul>
                    <li>立即对高风险设备进行安全加固，关闭不必要的端口和服务</li>
                    <li>定期更新所有网络设备的固件和系统补丁</li>
                    <li>为所有网络设备设置强密码，避免使用默认密码</li>
                    <li>限制网络共享访问权限，仅对必要用户开放</li>
                    <li>建立定期安全扫描和风险评估机制</li>
                    <li>加强网络安全监控，及时发现和处理安全事件</li>
                    <li>提高国产设备使用比例，增强自主可控能力</li>
                </ul>
                
                <div class="footer">
                    <p>© 2025 网络安全分析系统 | 维护人员: msyg | 版本: ${SYSTEM_VERSION}</p>
                    <p>本报告由网络设备安全分析报告系统自动生成</p>
                </div>
            </body>
            </html>
            `;
            
            return reportHtml;
        }
        
        // 导出数据
        function exportData() {
            if (devices.length === 0) {
                alert('没有数据可以导出，请先上传CSV文件或加载示例数据');
                return;
            }
            
            const dataToExport = {
                devices: devices,
                scanData: scanData,
                exportTime: new Date().toISOString(),
                version: SYSTEM_VERSION,
                maintainer: 'msyg'
            };
            
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `网络安全分析_${new Date().toISOString().slice(0, 10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert(`数据导出成功，共导出 ${devices.length} 个设备数据`);
        }
        
        // 显示导入模态框
        function showImportModal() {
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('importFileInputModal').value = '';
            showModal('importModal');
        }
        
        // 预览导入数据
        function previewImportData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    document.getElementById('importDataPreview').textContent = JSON.stringify(data, null, 2).substring(0, 1000) + '...';
                    document.getElementById('importPreview').style.display = 'block';
                } catch (error) {
                    alert('文件格式不正确，请选择正确的JSON文件');
                }
            };
            reader.readAsText(file);
        }
        
        // 确认导入数据
        function confirmImport() {
            const fileInput = document.getElementById('importFileInputModal');
            if (!fileInput.files[0]) {
                alert('请选择要导入的文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.devices && Array.isArray(importedData.devices)) {
                        // 添加式导入，覆盖重复数据
                        importedData.devices.forEach(newDevice => {
                            // 检查是否与现有设备重复（IP或MAC相同）
                            const duplicateIndex = devices.findIndex(device => 
                                device.ip === newDevice.ip || device.mac === newDevice.mac
                            );
                            
                            if (duplicateIndex !== -1) {
                                // 覆盖现有设备
                                devices[duplicateIndex] = newDevice;
                            } else {
                                // 添加新设备
                                devices.push(newDevice);
                            }
                        });
                        
                        // 合并扫描数据
                        if (importedData.scanData && Array.isArray(importedData.scanData)) {
                            importedData.scanData.forEach(newScan => {
                                // 查找是否已存在相同的扫描记录
                                const existingIndex = scanData.findIndex(scan => 
                                    scan.ip === newScan.ip && 
                                    scan.type === newScan.type && 
                                    scan.detail === newScan.detail
                                );
                                
                                if (existingIndex !== -1) {
                                    // 覆盖已存在的记录
                                    scanData[existingIndex] = newScan;
                                } else {
                                    // 添加新记录
                                    scanData.push(newScan);
                                }
                            });
                        }
                        
                        // 更新UI
                        mergeDataAndUpdate();
                        saveToLocalStorage();
                        
                        alert(`成功导入 ${importedData.devices.length} 个设备数据`);
                        hideModal('importModal');
                    } else {
                        alert('文件格式不正确，缺少设备数据');
                    }
                } catch (error) {
                    alert('文件解析失败: ' + error.message);
                }
            };
            reader.onerror = function() {
                alert('读取文件失败');
            };
            reader.readAsText(fileInput.files[0]);
        }
        
        // 显示确认清除数据模态框
        function showConfirmClearModal() {
            if (devices.length === 0) {
                alert('当前没有数据可清除');
                return;
            }
            
            showModal('confirmClearModal');
        }
        
        // 清除全部数据
        function clearAllData() {
            // 清除数据数组
            devices = [];
            scanData = [];
            
            // 清除本地存储
            localStorage.removeItem('networkSecurityData');
            
            // 重置筛选器
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('deviceTypeFilter').value = '';
            document.getElementById('domesticFilter').value = '';
            document.getElementById('riskFilter').value = '';
            
            // 重置图表数据到初始值
            resetCharts();
            
            // 更新UI
            updateDeviceTable();
            updateStatusIndicators();
            
            // 更新时间戳
            updateTimestamp();
            
            // 隐藏确认模态框
            hideModal('confirmClearModal');
            
            alert('所有数据已清除，系统已重置');
        }
        
        // 重置图表数据到初始值
        function resetCharts() {
            if (charts.statusChart) {
                charts.statusChart.data.datasets[0].data = [0, 0];
                charts.statusChart.update();
            }
            
            if (charts.riskChart) {
                charts.riskChart.data.datasets[0].data = [0, 0, 0, 0];
                charts.riskChart.update();
            }
            
            if (charts.deviceTypeChart) {
                charts.deviceTypeChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0];
                charts.deviceTypeChart.update();
            }
            
            if (charts.domesticChart) {
                charts.domesticChart.data.datasets[0].data = [0, 0];
                charts.domesticChart.update();
            }
        }
        
        // 刷新数据
        function refreshData() {
            if (devices.length === 0) {
                alert('没有数据可以刷新，请先上传CSV文件或加载示例数据');
                return;
            }
            
            mergeDataAndUpdate();
            updateTimestamp();
            alert('数据已刷新');
        }
        
        // 筛选设备
        function filterDevices() {
            updateDeviceTable();
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            const dataToSave = {
                devices: devices,
                scanData: scanData,
                saveTime: new Date().toISOString(),
                version: SYSTEM_VERSION
            };
            
            localStorage.setItem('networkSecurityData', JSON.stringify(dataToSave));
            console.log('数据已保存到本地存储');
        }
        
        // 从本地存储加载
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('networkSecurityData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    devices = parsedData.devices || [];
                    scanData = parsedData.scanData || [];
                    
                    if (devices.length > 0) {
                        mergeDataAndUpdate();
                        console.log('从本地存储加载了数据');
                    }
                } catch (error) {
                    console.error('加载本地存储数据失败:', error);
                }
            }
        }
        
        // 显示模态框
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        // 隐藏模态框
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // 更新时间戳
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleString('zh-CN');
        }
        
        // 定期更新时间
        function updateTime() {
            setInterval(() => {
                updateTimestamp();
            }, 60000);
        }
        
        // HTML转义函数，防止XSS攻击
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>